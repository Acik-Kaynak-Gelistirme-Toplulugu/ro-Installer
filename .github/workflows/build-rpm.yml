name: Build and Release RPM

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build RPM Package
    runs-on: ubuntu-latest
    container: fedora:40
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Install Build Dependencies
        run: |
          dnf update -y
          dnf install -y rpm-build rpmdevtools tar
          
      - name: Setup RPM Build Environment
        run: |
          rpmdev-setuptree
          echo "RPM Tree Created."
          
      - name: Prepare Source Archive
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Building RPM for version $VERSION"
          
          # Update the version in the spec file to match the tag
          sed -i "s/^Version:.*/Version:        $VERSION/" ro-installer.spec
          
          # Create the source tarball expected by rpmbuild
          mkdir -p ~/rpmbuild/SOURCES/ro-installer-$VERSION
          cp -r ./* ~/rpmbuild/SOURCES/ro-installer-$VERSION/
          cd ~/rpmbuild/SOURCES
          tar -czvf ro-installer-$VERSION.tar.gz ro-installer-$VERSION/
          rm -rf ro-installer-$VERSION
          
      - name: Build RPM
        run: |
          # Move spec file to SPECS directory
          mv ro-installer.spec ~/rpmbuild/SPECS/
          cd ~/rpmbuild/SPECS
          
          # Build binary and source packages (noarch)
          rpmbuild -ba ro-installer.spec
          
          # Move compiled RPMs to workspace for upload
          cp ~/rpmbuild/RPMS/noarch/*.rpm $GITHUB_WORKSPACE/
          
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: "*.rpm"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
